基础 - 修改数据库结构
===

- 文档编写：KK

- 2016.11.08

---

数据库的创建和回滚是使用Yii的Migration（迁移）实现的

迁移脚本放在**server/console/migrations**里，要执行迁移请在console目录里运行`_tools.bat`，选项1是`migrate/down all`，选项2和3都是`migrate/up`，不过2会附加模拟数据

---

### 数据库文件

`server/data`目录下的`database.db`就是程序运行时读取的数据库（SqLite3）

其中同目录下的`database-test.db`是**server/tests**下的测试代码运行时读写的镜像数据库，平时不用管这个数据库，运行测试后同时会产生`database-test.db_snapshot`这个快照文件也不用管它

---

### 创建表要注意

- 表名和字段名命名规范：**全小写，下划线分词**

- 每创建一个表都定义对应的`private function _表名_create(){}`方法来处理

	细心的你看看init迁移的safeUp方法就会发现，这个迁移调用了自身的所有命名结尾为`_create`的方法，而这些方法就是各个表的创建代码

	以后大家创建表应该按照相同的命名规则去增加建表脚本，不需要创建新的迁移来专门搞新表，除非发布后有版本更新吧
	
	---
	
- 字段声明

	所有字段都要声明`notNull`和`comment`注释
	
- 默认值

	有些字段可以声明默哀值的就声明`defaultValue`，其中这些默认值不得与业务逻辑有任何关系，如果字段类型是数字那就全部默认0，是字符就默认空字符串，是日期时间就默认`0000-00-00 00:00:00`等
	
- 逻辑值选型

	用0 1保存是否逻辑的字段要使用`boolean`
	
	在sqlite里就是boolean，在MySQL里会被转换成tinyint
	
	并且统一声明默认值为false
	
	---
	
- 关联字段

	项目由员工创建的，则project表的创建员工ID字段名应该是`worker_id`，其中`worker`前缀表示worker表，这样一看就知道这个字段与worker表有关，而后缀`id`就是指关联表的`id`这个字段
	
	在Migration里书写这些关联字段时，表名分需要使用`模型::tableName()`来动态获取，以减少表名重构的修改成本
	
	但在业务代码里用到关联字段的处理就不需要用tableName方法了，那样太极端了，在Migration里用是因为Migration就是迁移时跑一遍而已，又不是平时运行业务时都跑的，这样起码在定义表结构的过程中就不需要麻烦地到处修改表名
	
	---
	
- 创建基础数据

	有些表是需要有基础数据才能使程序运行起来（目前的开发阶段还没出现）
	
	此时就要在create方法里创建表后继续执行batchInsert来插入基础数据了

	---
	
- 表结构设计文档

	init迁移就是表结构文档，从里面可以看到各个表的字段、类型、注释和关联表字段等
	
---

### 创建模拟数据

经我改造后的Migration拥有模拟数据的控制功能，例如通过`_worker_create`方法创建数据表的结构后，还需要默认有几个工作人员做测试的话，则是通过`_worker_mock`方法来创建模拟数据（统一用batchInsert方法以便插入多条数据，不要一条条数据插入）

定义了mock方法模拟表数据后，在`_tools.bat`中使用选项2来构造数据库就会有这些模拟数据

---

### 功能设计

本项目的面向的主要用户群体中小型协作团队，所以按中小项目规模评估设计数据表即可

但如果做起来并不麻烦的话，能满足性能就尽可能满足性能