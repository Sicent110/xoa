!function(a,t){function e(a){var e=t(a.delegateTarget).data("id"),s=new Date,r=s.getFullYear()+"/"+s.getMonth()+"/"+s.getDate()+" 18:00",n=new ModalDialog({width:500,height:520,title:"新任务",content:'<form role="form" class="wrapAddTaskWorker">			<div class="form-group">				<input type="text" class="form-control J-taskTitle" placeholder="任务标题">			</div>			<div class="form-group">				<textarea class="form-control J-detail" rows="5" placeholder="任务详情，选填"></textarea>			</div>			<div class="form-group">				<button type="button" class="btn btn-success J-btnAddWorker">+负责人</button>				<span class="J-wrapWorkerResult"></span>			</div>			<div class="checkbox warpMembers J-wrapSelectWorkers"></div>			<div class="form-group">				<button type="button" class="btn btn-success J-btnAddRelatedMember">+相关人员</button>				<span class="J-wrapRelatedMembersResult"></span>			</div>			<div class="checkbox warpMembers J-wrapSelectRelationWorkers"></div>			<div class="form-group">				<label>完成时间：</label>\n				<input class="form-control J-limitTime" type="dateTime-local" value="'+r+'">			</div>		</form>',footer:'<button type="button" class="btn btn-primary J-submit">确定</button>'});n.__defineGetter__("selectedWorkerIds",function(){var a=[];return this.find(".J-wrapWorkerResult .J-worker").each(function(){a.push(t(this).data("id"))}),a}),n.__defineGetter__("selectedRelatedMemberIds",function(){var a=[];return this.find(".J-wrapRelatedMembersResult .J-member").each(function(){a.push(t(this).data("id"))}),a}),n.on("click",".J-btnAddWorker",function(){var a=t(this),e=n.find(".J-wrapWorkerResult"),s=n.find(".J-wrapSelectWorkers");if("+负责人"==a.text()){var r=n.data("members");r||App.ajax({url:"/project/"+App.aParams.projectId+"/members.json",async:!1,success:function(a){n.data("members",a.data),r=a.data}});var i=n.selectedWorkerIds,d=[];for(var o in r){var l=-1!==t.inArray(r[o].id,i)?" checked":"";d.push('<label class="J-memberItem"><input class="J-member" type="checkbox" value="'+r[o].id+'"'+l+">"+r[o].name+"</label>")}s.html(d.join("")),a.text("确定")}else{var d=[];s.find(":checkbox").each(function(){this.checked&&d.push('<label class="J-worker" data-id="'+this.value+'">'+t(this).closest(".J-memberItem").text()+"</label>")}),e.html(d.join("、")),s.empty(),a.text("+负责人")}}),n.on("click",".J-btnAddRelatedMember",function(){var a=t(this),e=n.find(".J-wrapRelatedMembersResult"),s=n.find(".J-wrapSelectRelationWorkers");if("+相关人员"==a.text()){var r=n.data("members");r||App.ajax({url:"/project/"+App.aParams.projectId+"/members.json",async:!1,success:function(a){n.data("members",a.data),r=a.data}});var i=n.selectedRelatedMemberIds,d=[];for(var o in r){var l=-1!==t.inArray(r[o].id,i)?" checked":"";d.push('<label class="J-memberItem"><input class="J-member" type="checkbox" value="'+r[o].id+'"'+l+">"+r[o].name+"</label>")}s.html(d.join("")),a.text("确定")}else{var d=[];s.find(":checkbox").each(function(){this.checked&&d.push('<label class="J-member" data-id="'+this.value+'">'+t(this).closest(".J-memberItem").text()+"</label>")}),e.html(d.join("、")),s.empty(),a.text("+相关人员")}}),n.find(".J-submit").click(function(){var a=n.find(".J-taskTitle").val().trim(),t=n.find(".J-detail").val().trim(),s=n.selectedWorkerIds,r=n.selectedRelatedMemberIds,i=n.find(".J-limitTime").val();return a?s.length?void App.ajax({url:"/task/add.do",data:{title:a,detail:t,taskCategoryId:e,workerIds:s,relatedMemberIds:r,limitTime:i},success:function(a){if(alert(a.message),!a.code){var t=new d(a.data),s=Page.getTaskCategory(e);s.addTask(t),n.hide()}}}):alert("请选择负责人"):alert("请输入任务标题")}),n.show()}function s(a){var s=this;s.id=a.id,s.name=a.name;var r=t('<div class="col-md-4 taskList J-taskList" data-id="'+s.id+'">\n		<h4 class="J-taskCategoryName">\n			'+s.name+'			<button type="button" class="btn btn-primary J-btnAddTask">+任务</button>		</h4>\n		<div class="J-listItems">\n			\n		</div>	</div>');return r.find(".J-taskCategoryName").hover(function(){t(this).find(".J-btnAddTask").show()},function(){t(this).find(".J-btnAddTask").hide()}),r.on("click",".J-btnAddTask",e),r.refreshTasks=function(){var a=this.find(".J-listItems").empty();App.ajax({url:"/task/"+this.data("id")+"/tasks.json",success:function(t){for(var e in t.data){var s=new d(t.data[e]);Page.aTasks[t.data[e].id]=s,s.css("opacity",0),a.append(s),s.animate({opacity:1},1e3)}}})},r.addTask=function(a){this.find(".J-listItems").append(a)},r.on("dragover",function(a){a.preventDefault();var e=t(a.target).hasClass("J-item");r.data("dont_append",e)}),r.on("drop",function(){r.data("dont_append")||c(Page.$dragingTask,t(this).find(".J-listItems"),!0),r.data("dont_append",!1)}),r.on("click",".J-item",function(){var a=Page.aTasks[t(this).data("id")];a.showDetail()}),t.extend(s,r)}function r(){var a=t("#wrapProjectHead"),e=a.find(".J-btnAddMember");a.hover(function(){e.show()},function(){e.hide()}),e.click(function(){var a=prompt("请输入他的UID，小x会发个加入邀请给他");if(a)return FormatValidator.isInteger(a)?void App.ajax({url:"/project/invite-member.do",data:{projectId:App.aParams.projectId,inviteWorkerId:a.trim()},success:function(a){App.alert(a.message)}}):void App.alert("UID是一个数字 (⊙ｏ⊙) 麻烦叫他进个人信息里看看")})}function n(){App.ajax({url:"/project/"+App.aParams.projectId+"/task-categorys.json",success:function(a){var e=t("#taskCategorys"),r=[];for(var n in a.data){var i=new s(a.data[n]);r.push(i),i.refreshTasks()}e.append(r),Page.aTaskCategorys=r}})}function i(){App.ajax({url:"/project/"+App.aParams.projectId+".json",success:function(a){t("#projectName").text(a.data.name)}})}function d(a){var e=function(a){return a.substr(5).substr(0,11)+" 完成"},s=[];for(var r in a.workers){var n=a.workers[r];s.push('<img class="pull-right avatar" src="'+n.avatar+'" title="'+n.name+'"/>')}var i='<div class="item J-item" draggable="true" data-id="'+a.id+'">		<p class="taskTitle"><input type="checkbox" class="J-chkFinish" />'+a.title+'</p>		<p>			<span class="pull-left">'+e(a.limit_time)+"</span>			"+s.join("")+"		</p>	</div>",d=t.extend(this,t(i));return d.on("dragstart",function(a){Page.$dragingTask=t(this)}),d.on("dragover",function(a){a.preventDefault()}),d.on("drop",function(){c(Page.$dragingTask,t(this))}),d.showDetail=function(){var a=this.data("detail");if(a){var t=l(a);return void t.show()}var e=this;App.ajax({url:"/task/"+this.data("id")+".json",success:function(a){if(a.code)return void App.alert(a.message);e.data("detail",a.data);var t=l(a.data);t.show()}})},d}function o(a,e){var s=t('<div class="row wrapAddChildTaskForm">\n		<textarea class="form-control J-content" rows="2"></textarea>\n		<p>\n			<span class="limitTime J-childTaskLimitTime">期限</span>\n			<img class="avatar J-childTaskWorker" src="'+a.avatar+'" title="'+a.name+'"/>\n			<span class="close J-close"></span>\n			<button type="button" class="btn btn-success J-saveChildTask">保存</button>\n		</p>\n	</div>');return s.find(".J-saveChildTask").click(function(){var t=s.find(".J-content").val(),r=a;App.ajax({url:"/task/add-child-task.do",data:{},success:function(a){return a.code?void alert(a.message):(s.remove(),e.show(),void e.before('<div class="row childTask">\n					<div class="pull-left childContent">'+t+'</div>\n					<div class="pull-right childInfo">\n						明天 <img class="avatar avatarSmall" src="'+r.avatar+'"/>\n					</div>\n				</div>'))}})}),s}function l(a){var e=function(){var t=[];for(var e in a.workers){var s=a.workers[e];t.push('<img class="avatar avatarSmall" src="'+s.avatar+'" title="'+s.name+'"/>')}return t.join("")}(),s=function(){var t=[];for(var e in a.related_members){var s=a.related_members[e];t.push('<img class="avatar avatarSmall" src="'+s.avatar+'" title="'+s.name+'"/>')}return t.join("")}(),r=new ModalDialog({width:500,height:520,title:"任务详情",dialogClass:"wrapTaskDetail",content:'<form role="form">			<div class="form-group taskTitle J-taskTitle" contenteditable="true">'+a.title+'</div>			<div class="form-group">\n				<div class="row topInfo">\n					<div class="col-md-3">\n						<p>负责人</p>\n						<p>'+e+'</p>\n					</div>\n					<div class="col-md-3">\n						<p>截止时间</p>\n						<p>'+a.limit_time+'</p>\n					</div>\n					<div class="col-md-3">\n						<p>优先级</p>\n						<p>'+Page.aVars.levels[a.level]+'</p>\n					</div>\n					<div class="col-md-3">\n						<p>重复</p>\n						<p>'+Page.aVars.repeats[a.repeat]+'</p>\n					</div>\n				</div>\n			</div>			<div class="form-group">\n				<textarea class="form-control J-detail" rows="4" placeholder="任务详情，支持用Markdown书写">'+a.detail+'</textarea>			</div>			<div class="form-group">\n				<div class="row J-wrapAddChildTask">\n					<button type="button" class="btn btn-warning btnAddChildTask">+子任务</button>				</div>			</div>			<div class="form-group">\n				<div class="row">相关人员：'+s+"</div>			</div>		</form>",footer:'<button data-dismiss="modal" class="btn btn-default">关闭</button>'}),n=r.find(".J-taskTitle"),i=r.find(".J-detail");return n.data("last_content",n.text()),i.data("last_content",i.val()),r.find(n.selector+","+i.selector).blur(function(){var e=t(this),s=e.data("last_content"),r=e.hasClass("J-taskTitle"),d=r?e.text():e.val();d!=s&&App.ajax({url:"/task/update.do",data:{taskId:a.id,title:n.text(),detail:i.val()},success:function(a){return a.code?void alert(a.message):void e.data("last_content",r?e.text():e.val())}})}),r.find(".btnAddChildTask").click(function(){var e=t(this).closest(".J-wrapAddChildTask");e.hide();var s=o(a.workers[0],e);e.after(s)}),r}function c(a,t,e){e?t.append(a):t.before(a);var s=a.data("id");App.ajax({url:"/task/move.do",data:{taskId:s,taskCategoryId:a.closest(".J-taskList").data("id"),order:a.index()+1},success:function(a){a.code&&App.alert(a.message)},error:function(){App.alert("移动出错，请重新加载页面")}}),a.addClass("dou"),setTimeout(function(){a.removeClass("dou")},500),Page.$dragingTask=null}a.Page={aTaskCategorys:[],aTasks:[],$dragingTask:null,getTaskCategory:function(a){for(var t in this.aTaskCategorys)if(this.aTaskCategorys[t].data("id")==a)return this.aTaskCategorys[t]},aVars:{},render:function(){App.loadParam("project/<projectId:\\d+>.htm"),r(),i(),n()}}}(window,jQuery);