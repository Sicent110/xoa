define(["app","modal-dialog"],function(a,t){function s(s){var l=function(){var a=[];for(var t in s.workers){var n=s.workers[t];a.push('<img class="avatar avatarSmall" src="'+n.avatar+'" title="'+n.name+'"/>')}return a.join("")}(),e=function(){var a=[];for(var t in s.related_members){var n=s.related_members[t];a.push('<img class="avatar avatarSmall" src="'+n.avatar+'" title="'+n.name+'"/>')}return a.join("")}(),r=t.build({width:500,height:520,title:"任务详情",dialogClass:"wrapTaskDetail",content:'<form role="form">				<div class="form-group taskTitle J-taskTitle" contenteditable="true">'+s.title+'</div>				<div class="form-group">\n					<div class="row topInfo">\n						<div class="col-md-3">\n							<p>负责人</p>\n							<p>'+l+'</p>\n						</div>\n						<div class="col-md-3">\n							<p>截止时间</p>\n							<p>'+s.limit_time+'</p>\n						</div>\n						<div class="col-md-3">\n							<p>优先级</p>\n							<p>'+i.dict.levels[s.level]+'</p>\n						</div>\n						<div class="col-md-3">\n							<p>重复</p>\n							<p>'+i.dict.repeats[s.repeat]+'</p>\n						</div>\n					</div>\n				</div>				<div class="form-group">\n					<textarea class="form-control J-detail" rows="4" placeholder="任务详情，支持用Markdown书写">'+s.detail+'</textarea>				</div>				<div class="form-group">\n					<div class="row J-wrapAddChildTask">\n						<button type="button" class="btn btn-warning btnAddChildTask">+子任务</button>					</div>				</div>				<div class="form-group">\n					<div class="row">相关人员：'+e+"</div>				</div>			</form>",footer:'<button data-dismiss="modal" class="btn btn-default">关闭</button>'}),d=r.find(".J-taskTitle"),o=r.find(".J-detail");return d.data("last_content",d.text()),o.data("last_content",o.val()),r.find(d.selector+","+o.selector).blur(function(){var t=$(this),n=t.data("last_content"),i=t.hasClass("J-taskTitle"),l=i?t.text():t.val();l!=n&&a.ajax({url:"/task/update.do",data:{taskId:s.id,title:d.text(),detail:o.val()},success:function(a){return a.code?void alert(a.message):void t.data("last_content",i?t.text():t.val())}})}),r.find(".btnAddChildTask").click(function(){var a=$(this).closest(".J-wrapAddChildTask");a.hide();var t=n(s.workers[0],a);a.after(t)}),r}function n(t,s){var n=$('<div class="row wrapAddChildTaskForm">\n			<textarea class="form-control J-content" rows="2"></textarea>\n			<p>\n				<span class="limitTime J-childTaskLimitTime">期限</span>\n				<img class="avatar J-childTaskWorker" src="'+t.avatar+'" title="'+t.name+'"/>\n				<span class="close J-close"></span>\n				<button type="button" class="btn btn-success J-saveChildTask">保存</button>\n			</p>\n		</div>');return n.find(".J-saveChildTask").click(function(){var i=n.find(".J-content").val(),l=t;a.ajax({url:"/task/add-child-task.do",data:{},success:function(a){return a.code?void alert(a.message):(n.remove(),s.show(),void s.before('<div class="row childTask">\n						<div class="pull-left childContent">'+i+'</div>\n						<div class="pull-right childInfo">\n							明天 <img class="avatar avatarSmall" src="'+l.avatar+'"/>\n						</div>\n					</div>'))}})}),n}var i={dict:{levels:{},repeats:{}},build:s};return i});