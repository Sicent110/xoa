define(["app","task-item"],function(e,t){function a(a){require(["modal-dialog"],function(s){var r=$(a.delegateTarget).data("id"),d=new Date,n=d.getFullYear()+"/"+d.getMonth()+"/"+d.getDate()+" 18:00",o=s.build({width:500,height:520,title:"新任务",content:'<form role="form" class="wrapAddTaskWorker">					<div class="form-group">						<input type="text" class="form-control J-taskTitle" placeholder="任务标题">					</div>					<div class="form-group">						<textarea class="form-control J-detail" rows="5" placeholder="任务详情，选填"></textarea>					</div>					<div class="form-group">						<button type="button" class="btn btn-success J-btnAddWorker">+负责人</button>						<span class="J-wrapWorkerResult"></span>					</div>					<div class="checkbox warpMembers J-wrapSelectWorkers"></div>					<div class="form-group">						<button type="button" class="btn btn-success J-btnAddRelatedMember">+相关人员</button>						<span class="J-wrapRelatedMembersResult"></span>					</div>					<div class="checkbox warpMembers J-wrapSelectRelationWorkers"></div>					<div class="form-group">						<label>完成时间：</label>\n						<input class="form-control J-limitTime" type="dateTime-local" value="'+n+'">					</div>				</form>',footer:'<button type="button" class="btn btn-primary J-submit">确定</button>'});o.__defineGetter__("selectedWorkerIds",function(){var e=[];return this.find(".J-wrapWorkerResult .J-worker").each(function(){e.push($(this).data("id"))}),e}),o.__defineGetter__("selectedRelatedMemberIds",function(){var e=[];return this.find(".J-wrapRelatedMembersResult .J-member").each(function(){e.push($(this).data("id"))}),e}),o.on("click",".J-btnAddWorker",function(){var t=$(this),a=o.find(".J-wrapWorkerResult"),s=o.find(".J-wrapSelectWorkers");if("+负责人"==t.text()){var r=o.data("members");r||e.ajax({url:"/project/"+e.aParams.projectId+"/members.json",async:!1,success:function(e){o.data("members",e.data),r=e.data}});var i=o.selectedWorkerIds,d=[];for(var n in r){var l=-1!==$.inArray(r[n].id,i)?" checked":"";d.push('<label class="J-memberItem"><input class="J-member" type="checkbox" value="'+r[n].id+'"'+l+">"+r[n].name+"</label>")}s.html(d.join("")),t.text("确定")}else{var d=[];s.find(":checkbox").each(function(){this.checked&&d.push('<label class="J-worker" data-id="'+this.value+'">'+$(this).closest(".J-memberItem").text()+"</label>")}),a.html(d.join("、")),s.empty(),t.text("+负责人")}}),o.on("click",".J-btnAddRelatedMember",function(){var t=$(this),a=o.find(".J-wrapRelatedMembersResult"),s=o.find(".J-wrapSelectRelationWorkers");if("+相关人员"==t.text()){var r=o.data("members");r||e.ajax({url:"/project/"+e.aParams.projectId+"/members.json",async:!1,success:function(e){o.data("members",e.data),r=e.data}});var i=o.selectedRelatedMemberIds,d=[];for(var n in r){var l=-1!==$.inArray(r[n].id,i)?" checked":"";d.push('<label class="J-memberItem"><input class="J-member" type="checkbox" value="'+r[n].id+'"'+l+">"+r[n].name+"</label>")}s.html(d.join("")),t.text("确定")}else{var d=[];s.find(":checkbox").each(function(){this.checked&&d.push('<label class="J-member" data-id="'+this.value+'">'+$(this).closest(".J-memberItem").text()+"</label>")}),a.html(d.join("、")),s.empty(),t.text("+相关人员")}}),o.find(".J-submit").click(function(){var a=o.find(".J-taskTitle").val().trim(),s=o.find(".J-detail").val().trim(),d=o.selectedWorkerIds,n=o.selectedRelatedMemberIds,l=o.find(".J-limitTime").val();return a?d.length?void e.ajax({url:"/task/add.do",data:{title:a,detail:s,taskCategoryId:r,workerIds:d,relatedMemberIds:n,limitTime:l},success:function(a){if(e.alert(a.message),!a.code){var s=t.build(a.data);i.aTasks[a.data.id]=s;var d=i.getTaskCategory(r);d.addTask(s),o.hide()}}}):alert("请选择负责人"):alert("请输入任务标题")}),o.show()})}function s(s){var r=$('<div class="col-md-4 taskList J-taskList" data-id="'+s.id+'">\n			<h4 class="J-taskCategoryName">\n				'+s.name+'				<button type="button" class="btn btn-primary J-btnAddTask">+任务</button>			</h4>\n			<div class="J-listItems">\n				\n			</div>		</div>');return r.find(".J-taskCategoryName").hover(function(){$(this).find(".J-btnAddTask").show()},function(){$(this).find(".J-btnAddTask").hide()}),r.on("click",".J-btnAddTask",a),r.refreshTasks=function(){var a=this.find(".J-listItems").empty();e.ajax({url:"/task/"+this.data("id")+"/tasks.json",success:function(e){for(var s in e.data){var r=t.build(e.data[s]);i.aTasks[e.data[s].id]=r,r.css("opacity",0),a.append(r),r.animate({opacity:1},1e3)}}})},r.addTask=function(e){this.find(".J-listItems").append(e)},r.on("dragover",function(e){e.preventDefault();var t=$(e.target).hasClass("J-item");r.data("dont_append",t)}),r.on("drop",function(){r.data("dont_append")||i.moveTask(i.$dragingTask,$(this).find(".J-listItems"),!0),r.data("dont_append",!1)}),r.on("click",".J-item",function(){var t=i.aTasks[$(this).data("id")];return t?void t.showDetail():void e.alert("找不到任务实例")}),$.extend({id:s.id,name:s.name},r)}function r(t,a,s){s?a.append(t):a.before(t);var r=t.data("id");e.ajax({url:"/task/move.do",data:{taskId:r,taskCategoryId:t.closest(".J-taskList").data("id"),order:t.index()+1},success:function(t){t.code&&e.alert(t.message)},error:function(){e.alert("移动出错，请重新加载页面")}}),t.addClass("dou"),setTimeout(function(){t.removeClass("dou")},500),i.$dragingTask=null}var i={build:s,moveTask:r,$dragingTask:null,aTaskCategorys:[],aTasks:[],getTaskCategory:function(e){for(var t in this.aTaskCategorys)if(this.aTaskCategorys[t].data("id")==e)return this.aTaskCategorys[t]}};return i});